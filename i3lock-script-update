#!/bin/bash

source i3lock-script-static.sh

##############################
# Pywal setting
##############################
use_pywal=$(get-value 'general.use-pywal')
if [[ "$use_pywal" == 'true' ]]; then
	file_pywal="${XDG_CACHE_HOME:-"$HOME/.cache"}/wal/colors.i3lock"
fi

##############################
# Get configurable settings
##############################
default_arguments=$(get-value 'general.arguments')

screen_background_color=$(get-value 'screen.background-color')
screen_background_image=$(get-value 'screen.background-image')
screen_background_image="${screen_background_image//\~/$HOME}"

box_background_color=$(get-value 'box.background-color')
box_margin=$(get-value 'box.margin')
box_padding=$(get-value 'box.padding')

ring_width=$(get-value 'ring.width')
ring_color=$(get-value 'ring.color')
ring_color_highlight=$(get-value 'ring.color-highlight')
ring_color_wrong=$(get-value 'ring.color-wrong')
ring_color_remove=$(get-value 'ring.color-remove')

text_font=$(get-value 'text.font')
text_color=$(get-value 'text.color')
text_spacing=$(get-value 'text.spacing')

time_format=$(get-value 'time.format')
time_width=$(get-value 'time.width')
time_size=$(get-value 'time.size')
date_format=$(get-value 'date.format')
date_width=$(get-value 'date.width')
date_size=$(get-value 'date.size')

##############################
# Computations for locations and sizes
##############################
# The width and height of the text is kinda hard to know. 
# Currently using multipliers 4 and 13 for the width and 0.8 for the height seems to give good results.
# The 4 and 13 should be replaced with some other solution, but I don't know what at this moment.
time_width=`expr $time_width \* $time_size`
date_width=`expr $date_width \* $date_size`
text_width=$(($time_width>$date_width?$time_width:$date_width))

text_height=`expr \( $time_size + $date_size \) \* 8 / 10 + $text_spacing`
ring_radius=`expr \( $text_height - $ring_width \) / 2`

text_x=`expr $box_margin + $box_padding`
ring_x=`expr $text_x + $text_width + $box_padding + $ring_radius + $ring_width / 2`

date_y=`expr -$box_margin - $box_padding`
time_y=`expr $date_y - $text_spacing - $date_size`
ring_y=`expr $date_y - $text_height / 2`

##############################
# If an image is given, we need to blur it and draw the rectangle on it.
# For the rectangle we need to compute some more locations
##############################
if [[ -f "$screen_background_image" ]]; then
	box_border_radius=$(get-value 'box.border-radius')

	box_x_min=`expr $text_x - $box_margin`
	box_y_min=`expr $date_y + $box_margin`
	box_x_max=`expr $ring_x + $box_padding + $ring_radius + $ring_width / 2`
	box_y_max=`expr $box_y_min - $box_padding \* 2 - $text_height`

	magick "$screen_background_image" \
		-blur 6x6 \
		-draw "fill #$box_background_color roundrectangle $box_x_min,%[fx:h+$box_y_max] $box_x_max,%[fx:h+$box_y_min] $box_border_radius,$box_border_radius" \
		"$file_background"
else
	rm -f "$file_background"
fi

##############################
# Write the lock file
##############################
background_arg=''
if [[ -f "$screen_background_image" ]]; then
	background_arg="--image '$file_background'"
fi
cat <<- EOF > "$file_lock"
#!/bin/bash
# Generated by i3lock-script

i3lock \\
	--force-clock \\
	--indpos=" x + $ring_x : h + $ring_y" \\
	--timepos="x + $text_x : h + $time_y" \\
	--datepos="x + $text_x : h + $date_y" \\
	--time-align 1 \\
	--date-align 1 \\
	--timestr='$time_format' \\
	--datestr='$date_format' \\
	--veriftext='' \\
	--noinputtext='' \\
	--wrongtext='' \\
	--radius="$ring_radius" \\
	--ring-width="$ring_width" \\
	--timesize="$time_size" \\
	--datesize="$date_size" \\
	-c "$screen_background_color" \\
	--datecolor="$text_color" \\
	--timecolor="$text_color" \\
	--verifcolor="$text_color" \\
	--insidevercolor="$color_transparent" \\
	--ringvercolor="$color_transparent" \\
	--wrongcolor="$ring_color_wrong" \\
	--insidewrongcolor="$ring_color_wrong" \\
	--ringwrongcolor="$ring_color" \\
	--ringcolor="$ring_color" \\
	--insidecolor="$color_transparent" \\
	--linecolor="$color_transparent" \\
	--keyhlcolor="$ring_color_highlight" \\
	--bshlcolor="$ring_color_remove" \\
	--separatorcolor="$color_transparent" \\
	--time-font="$text_font" \\
	--date-font="$text_font" \\
	--layout-font="$text_font" \\
	--verif-font="$text_font" \\
	--wrong-font="$text_font" \\
	$background_arg \\
	$default_arguments \\
	\$@
EOF
chmod +x "$file_lock"
